with initial_entities as (
select distinct entity_id from 
 clean.encounters enc
 left join clean.demographics demo using (entity_id)
 left join clean.death death using (entity_id)
 --left join clean.diagnosis diag using (entity_id)
        
 WHERE (enc.ADMIT_DATE > '{as_of_date}'::date - interval '3year'
 and enc.ADMIT_DATE < '{as_of_date}'::date
and demo.birth_date < '{as_of_date}'::date - interval '18year'
and (death.DEATH_DATE > '{as_of_date}'::date or death.DEATH_DATE is null)
 )),

diagnosis_exclusions as (
select distinct entity_id from 
  clean.diagnosis  
where
-- prior_liver_comp_exclusion
((dx_date < '{as_of_date}'::date)
         and ((dx in ('I85.00',
                                                   'I85.01',
                                                   'I85.10',
                                                   'I85.11',
                                                   'I86.4',
                                                   'K74.60',
                                                   'K74.69',
                                                   'K76.6',
                                                   'K76.7',
                                                   'C22.0',
                                                   'R18.8',
                                                   'K76.82') and dx_type = '10')
                                        or (dx in ('456.0',
                                                   '456.1',
                                                   '456.20',
                                                   '456.21',
                                                   '571.5',
                                                   '572.2',
                                                   '572.3',
                                                   '572.4',
                                                   '789.51',
                                                   '789.59') and dx_type = '09'))
         or (
         
    --prior hepatitis exclusion        
         ((dx in ('B15.0'
                                      , 'B15.9'
                                      , 'B16.0'
                                      , 'B16.1'
                                      , 'B16.2'
                                      , 'B16.9'
                                      , 'B17.0'
                                      , 'B17.10'
                                      , 'B17.11'
                                      , 'B17.2'
                                      , 'B17.8'
                                      , 'B17.9'
                                      , 'B18.0'
                                      , 'B18.1'
                                      , 'B18.2'
                                      , 'B18.9'
                                      , 'B19.0'
                                      , 'B19.10'
                                      , 'B19.20'
                                      , 'B19.9'
                                      , 'K73.2'
                                      , 'K73.9'
                                      , 'K75.4')
                                    and dx_type = '10')
                                     or (dx in ('070.0'
                                      , '070.1'
                                      , '070.20'
                                      , '070.21'
                                      , '070.22'
                                      , '070.23'
                                      , '070.30'
                                      , '070.31'
                                      , '070.32'
                                      , '070.33'
                                      , '070.41'
                                      , '070.42'
                                      , '070.43'
                                      , '070.44'
                                      , '070.49'
                                      , '070.51'
                                      , '070.52'
                                      , '070.53'
                                      , '070.54'
                                      , '070.59'
                                      , '070.6'
                                      , '070.70'
                                      , '070.71'
                                      , '070.9')
                                    and dx_type = '09')))
              or (
                  --prior other liver exclusion
              ((dx in ('C22.1',
                                                     'C78.7',
                                                     'E83.01',
                                                     'E83.10',
                                                     'E83.110',
                                                     'E83.111',
                                                     'E83.118',
                                                     'E83.119',
                                                     'E83.19',
                                                     'E88.01',
                                                     'E88.02',
                                                     'E88.09',
                                                     'I82.0',
                                                     'K74.3',
                                                     'K74.4',
                                                     'K74.5',
                                                     'K83.0',
                                                     'R18.0',
                                                     'C22.2',
                                                     'C22.3',
                                                     'C22.4',
                                                     'C22.7',
                                                     'C22.8',
                                                     'C22.9',
                                                     'E83.00',
                                                     'E83.09') and dx_type = '10')
                                          or (dx in ('155.1',
                                                     '155.2',
                                                     '255.0',
                                                     '275.01',
                                                     '275.1',
                                                     '277.6',
                                                     '331.7',
                                                     '453.0',
                                                     '571.40',
                                                     '571.41',
                                                     '571.42',
                                                     '571.49',
                                                     '571.6',
                                                     '576.1',
                                                     '577.0') and dx_type = '09')))
              or (
                  --prior alcohol exclusion
               ((dx in ('E24.4',
                                                 'F10.10',
                                                 'F10.11',
                                                 'F10.120',
                                                 'F10.121',
                                                 'F10.129',
                                                 'F10.130',
                                                 'F10.131',
                                                 'F10.132',
                                                 'F10.139',
                                                 'F10.14',
                                                 'F10.150',
                                                 'F10.150',
                                                 'F10.151',
                                                 'F10.151',
                                                 'F10.159',
                                                 'F10.159',
                                                 'F10.180',
                                                 'F10.180',
                                                 'F10.181',
                                                 'F10.182',
                                                 'F10.188',
                                                 'F10.19',
                                                 'F10.20',
                                                 'F10.21',
                                                 'F10.220',
                                                 'F10.221',
                                                 'F10.229',
                                                 'F10.230',
                                                 'F10.231',
                                                 'F10.232',
                                                 'F10.239',
                                                 'F10.24',
                                                 'F10.250',
                                                 'F10.250',
                                                 'F10.251',
                                                 'F10.251',
                                                 'F10.259',
                                                 'F10.259',
                                                 'F10.26',
                                                 'F10.27',
                                                 'F10.280',
                                                 'F10.280',
                                                 'F10.281',
                                                 'F10.282',
                                                 'F10.288',
                                                 'F10.29',
                                                 'F10.920',
                                                 'F10.921',
                                                 'F10.929',
                                                 'F10.930',
                                                 'F10.931',
                                                 'F10.932',
                                                 'F10.939',
                                                 'F10.94',
                                                 'F10.950',
                                                 'F10.950',
                                                 'F10.951',
                                                 'F10.951',
                                                 'F10.959',
                                                 'F10.959',
                                                 'F10.96',
                                                 'F10.97',
                                                 'F10.980',
                                                 'F10.980',
                                                 'F10.981',
                                                 'F10.982',
                                                 'F10.988',
                                                 'F10.99',
                                                 'G31.2',
                                                 'G31.2',
                                                 'G62.1',
                                                 'G62.1',
                                                 'G72.1',
                                                 'I42.6',
                                                 'I42.6',
                                                 'K29.20',
                                                 'K29.20',
                                                 'K29.21',
                                                 'K29.21',
                                                 'K29.21',
                                                 'K70.0',
                                                 'K70.0',
                                                 'K70.10',
                                                 'K70.10',
                                                 'K70.11',
                                                 'K70.11',
                                                 'K70.2',
                                                 'K70.2',
                                                 'K70.30',
                                                 'K70.30',
                                                 'K70.31',
                                                 'K70.31',
                                                 'K70.40',
                                                 'K70.40',
                                                 'K70.41',
                                                 'K70.41',
                                                 'K70.41',
                                                 'K70.9',
                                                 'K70.9',
                                                 'K85.2',
                                                 'K85.20',
                                                 'K85.21',
                                                 'K85.22',
                                                 'K86.0',
                                                 'T51.0X1A',
                                                 'T51.0X1A',
                                                 'T51.0X1A',
                                                 'T51.0X1D',
                                                 'T51.0X1S',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2D',
                                                 'T51.0X2D',
                                                 'T51.0X2S',
                                                 'T51.0X2S',
                                                 'T51.0X3A',
                                                 'T51.0X3A',
                                                 'T51.0X3A',
                                                 'T51.0X3D',
                                                 'T51.0X3S',
                                                 'T51.0X4A',
                                                 'T51.0X4A',
                                                 'T51.0X4A',
                                                 'T51.0X4D',
                                                 'T51.0X4S',
                                                 'T51.91XA',
                                                 'T51.91XA',
                                                 'T51.91XA',
                                                 'T51.91XD',
                                                 'T51.91XS',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XD',
                                                 'T51.92XD',
                                                 'T51.92XS',
                                                 'T51.92XS',
                                                 'T51.93XA',
                                                 'T51.93XA',
                                                 'T51.93XA',
                                                 'T51.93XD',
                                                 'T51.93XS',
                                                 'T51.94XA',
                                                 'T51.94XA',
                                                 'T51.94XA',
                                                 'T51.94XD',
                                                 'T51.94XS',
                                                 'Z71.41') and dx_type = '10')
                                      or (dx in ('291.0',
                                                 '291.1',
                                                 '291.2',
                                                 '291.3',
                                                 '291.4',
                                                 '291.5',
                                                 '291.81',
                                                 '291.82',
                                                 '291.89',
                                                 '291.9',
                                                 '303.00',
                                                 '303.01',
                                                 '303.02',
                                                 '303.03',
                                                 '303.90',
                                                 '303.91',
                                                 '303.92',
                                                 '303.93',
                                                 '305.00',
                                                 '305.01',
                                                 '305.02',
                                                 '305.03',
                                                 '357.5',
                                                 '359.4',
                                                 '425.5',
                                                 '535.30',
                                                 '535.31',
                                                 '571.0',
                                                 '571.1',
                                                 '571.2',
                                                 '571.3',
                                                 '980.1',
                                                 '980.9',
                                                 'V65.42') and dx_type = '09')))
              
         
         )
),
liver_complication_outcome as 
(
   
   
   -- outcome
   -- liver outcome 
   select distinct entity_id from 
  clean.diagnosis  
where
(dx_date between '{as_of_date}'::date and ('{as_of_date}'::date + interval '{label_timespan}'))
         and ((dx in ('I85.00',
                                                   'I85.01',
                                                   'I85.10',
                                                   'I85.11',
                                                   'I86.4',
                                                   'K74.60',
                                                   'K74.69',
                                                   'K76.6',
                                                   'K76.7',
                                                   'C22.0',
                                                   'R18.8',
                                                   'K76.82') and dx_type = '10')
                                        or (dx in ('456.0',
                                                   '456.1',
                                                   '456.20',
                                                   '456.21',
                                                   '571.5',
                                                   '572.2',
                                                   '572.3',
                                                   '572.4',
                                                   '789.51',
                                                   '789.59') and dx_type = '09'))
)
,

diagnosis_exclusion_outcomes as (
                                                   
 select distinct entity_id from 
  clean.diagnosis  
where

(dx_date between '{as_of_date}'::date and ('{as_of_date}'::date + interval '{label_timespan}')   )        
and  (     
    --prior hepatitis exclusion        
         ((dx in ('B15.0'
                                      , 'B15.9'
                                      , 'B16.0'
                                      , 'B16.1'
                                      , 'B16.2'
                                      , 'B16.9'
                                      , 'B17.0'
                                      , 'B17.10'
                                      , 'B17.11'
                                      , 'B17.2'
                                      , 'B17.8'
                                      , 'B17.9'
                                      , 'B18.0'
                                      , 'B18.1'
                                      , 'B18.2'
                                      , 'B18.9'
                                      , 'B19.0'
                                      , 'B19.10'
                                      , 'B19.20'
                                      , 'B19.9'
                                      , 'K73.2'
                                      , 'K73.9'
                                      , 'K75.4')
                                    and dx_type = '10')
                                     or (dx in ('070.0'
                                      , '070.1'
                                      , '070.20'
                                      , '070.21'
                                      , '070.22'
                                      , '070.23'
                                      , '070.30'
                                      , '070.31'
                                      , '070.32'
                                      , '070.33'
                                      , '070.41'
                                      , '070.42'
                                      , '070.43'
                                      , '070.44'
                                      , '070.49'
                                      , '070.51'
                                      , '070.52'
                                      , '070.53'
                                      , '070.54'
                                      , '070.59'
                                      , '070.6'
                                      , '070.70'
                                      , '070.71'
                                      , '070.9')
                                    and dx_type = '09'))
              or (
                  --prior other liver exclusion
              ((dx in ('C22.1',
                                                     'C78.7',
                                                     'E83.01',
                                                     'E83.10',
                                                     'E83.110',
                                                     'E83.111',
                                                     'E83.118',
                                                     'E83.119',
                                                     'E83.19',
                                                     'E88.01',
                                                     'E88.02',
                                                     'E88.09',
                                                     'I82.0',
                                                     'K74.3',
                                                     'K74.4',
                                                     'K74.5',
                                                     'K83.0',
                                                     'R18.0',
                                                     'C22.2',
                                                     'C22.3',
                                                     'C22.4',
                                                     'C22.7',
                                                     'C22.8',
                                                     'C22.9',
                                                     'E83.00',
                                                     'E83.09') and dx_type = '10')
                                          or (dx in ('155.1',
                                                     '155.2',
                                                     '255.0',
                                                     '275.01',
                                                     '275.1',
                                                     '277.6',
                                                     '331.7',
                                                     '453.0',
                                                     '571.40',
                                                     '571.41',
                                                     '571.42',
                                                     '571.49',
                                                     '571.6',
                                                     '576.1',
                                                     '577.0') and dx_type = '09')))
              or (
                  --prior alcohol exclusion
               ((dx in ('E24.4',
                                                 'F10.10',
                                                 'F10.11',
                                                 'F10.120',
                                                 'F10.121',
                                                 'F10.129',
                                                 'F10.130',
                                                 'F10.131',
                                                 'F10.132',
                                                 'F10.139',
                                                 'F10.14',
                                                 'F10.150',
                                                 'F10.150',
                                                 'F10.151',
                                                 'F10.151',
                                                 'F10.159',
                                                 'F10.159',
                                                 'F10.180',
                                                 'F10.180',
                                                 'F10.181',
                                                 'F10.182',
                                                 'F10.188',
                                                 'F10.19',
                                                 'F10.20',
                                                 'F10.21',
                                                 'F10.220',
                                                 'F10.221',
                                                 'F10.229',
                                                 'F10.230',
                                                 'F10.231',
                                                 'F10.232',
                                                 'F10.239',
                                                 'F10.24',
                                                 'F10.250',
                                                 'F10.250',
                                                 'F10.251',
                                                 'F10.251',
                                                 'F10.259',
                                                 'F10.259',
                                                 'F10.26',
                                                 'F10.27',
                                                 'F10.280',
                                                 'F10.280',
                                                 'F10.281',
                                                 'F10.282',
                                                 'F10.288',
                                                 'F10.29',
                                                 'F10.920',
                                                 'F10.921',
                                                 'F10.929',
                                                 'F10.930',
                                                 'F10.931',
                                                 'F10.932',
                                                 'F10.939',
                                                 'F10.94',
                                                 'F10.950',
                                                 'F10.950',
                                                 'F10.951',
                                                 'F10.951',
                                                 'F10.959',
                                                 'F10.959',
                                                 'F10.96',
                                                 'F10.97',
                                                 'F10.980',
                                                 'F10.980',
                                                 'F10.981',
                                                 'F10.982',
                                                 'F10.988',
                                                 'F10.99',
                                                 'G31.2',
                                                 'G31.2',
                                                 'G62.1',
                                                 'G62.1',
                                                 'G72.1',
                                                 'I42.6',
                                                 'I42.6',
                                                 'K29.20',
                                                 'K29.20',
                                                 'K29.21',
                                                 'K29.21',
                                                 'K29.21',
                                                 'K70.0',
                                                 'K70.0',
                                                 'K70.10',
                                                 'K70.10',
                                                 'K70.11',
                                                 'K70.11',
                                                 'K70.2',
                                                 'K70.2',
                                                 'K70.30',
                                                 'K70.30',
                                                 'K70.31',
                                                 'K70.31',
                                                 'K70.40',
                                                 'K70.40',
                                                 'K70.41',
                                                 'K70.41',
                                                 'K70.41',
                                                 'K70.9',
                                                 'K70.9',
                                                 'K85.2',
                                                 'K85.20',
                                                 'K85.21',
                                                 'K85.22',
                                                 'K86.0',
                                                 'T51.0X1A',
                                                 'T51.0X1A',
                                                 'T51.0X1A',
                                                 'T51.0X1D',
                                                 'T51.0X1S',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2A',
                                                 'T51.0X2D',
                                                 'T51.0X2D',
                                                 'T51.0X2S',
                                                 'T51.0X2S',
                                                 'T51.0X3A',
                                                 'T51.0X3A',
                                                 'T51.0X3A',
                                                 'T51.0X3D',
                                                 'T51.0X3S',
                                                 'T51.0X4A',
                                                 'T51.0X4A',
                                                 'T51.0X4A',
                                                 'T51.0X4D',
                                                 'T51.0X4S',
                                                 'T51.91XA',
                                                 'T51.91XA',
                                                 'T51.91XA',
                                                 'T51.91XD',
                                                 'T51.91XS',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XA',
                                                 'T51.92XD',
                                                 'T51.92XD',
                                                 'T51.92XS',
                                                 'T51.92XS',
                                                 'T51.93XA',
                                                 'T51.93XA',
                                                 'T51.93XA',
                                                 'T51.93XD',
                                                 'T51.93XS',
                                                 'T51.94XA',
                                                 'T51.94XA',
                                                 'T51.94XA',
                                                 'T51.94XD',
                                                 'T51.94XS',
                                                 'Z71.41') and dx_type = '10')
                                      or (dx in ('291.0',
                                                 '291.1',
                                                 '291.2',
                                                 '291.3',
                                                 '291.4',
                                                 '291.5',
                                                 '291.81',
                                                 '291.82',
                                                 '291.89',
                                                 '291.9',
                                                 '303.00',
                                                 '303.01',
                                                 '303.02',
                                                 '303.03',
                                                 '303.90',
                                                 '303.91',
                                                 '303.92',
                                                 '303.93',
                                                 '305.00',
                                                 '305.01',
                                                 '305.02',
                                                 '305.03',
                                                 '357.5',
                                                 '359.4',
                                                 '425.5',
                                                 '535.30',
                                                 '535.31',
                                                 '571.0',
                                                 '571.1',
                                                 '571.2',
                                                 '571.3',
                                                 '980.1',
                                                 '980.9',
                                                 'V65.42') and dx_type = '09')))
              
         
         )
)

select initial_entities.entity_id,
(case when liver_complication_outcome.entity_id is not null and diagnosis_exclusion_outcomes.entity_id is null then 1 else 0 end) 
as outcome
from initial_entities left join liver_complication_outcome using (entity_id)
left join diagnosis_exclusion_outcomes using (entity_id)
where initial_entities.entity_id not in (select entity_id from diagnosis_exclusions)
